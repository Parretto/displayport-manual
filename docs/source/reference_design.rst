Reference Design
================

Introduction
------------
The reference design is shown in figure 3.
The reference design consists of the modules DisplayPort TX (DPTX), DisplayPort RX (DPRX), Video Toolbox (VTB), SERDES and application. 

The VTB is a collection of video helper modules. It has a timing generator, colorbar generator, FIFO and video clock recovery. 

The reference design has two operation modes; colorbar and pass-through. 
In colorbar mode the test pattern, generated by the VTB, is transmitted by the DPTX to the DisplayPort sink device.
When the pass-through mode is selected, the video coming from the DisplayPort source is captured by the DPRX. Then the video is forwarded to the DPTX through the VTB. 

The application has a RISC-V processor, memory (rom and ram) and a set of peripherals. 
The RISC-V processor runs the application code and DisplayPort IP-core host driver. 
The I2C peripheral is used to configure the external reference clock synthesizers (PHY and video clocks). 
The SERDES registers are accessed through the DRP / LMMI peripheral. 


.. figure:: ./images/reference_design.svg
   :alt: Reference design
   :align: center
   Figure 3: Reference design


Running
-------

This paragraph describes how to run the reference design on the board.

The reference design uses the `Tentiva board <https://www.parretto.com/tentiva.html>`_.
Tentiva is video FMC board with DisplayPort sink and source connectors.   
Mount the Tentiva board on the FPGA development board using the FMC HPC connector.
Connect the external DisplayPort sink to the DPTX connector and the connect the DisplayPort source device to the DPRX connector, 
like shown in the figure below. 

.. figure:: ./images/board-setup.png
   :alt: board-setup.png
   :align: center
   Figure 4: Board Setup


Connect the host PC to the FPGA boards USB interface. 
Open a serial terminal and set the baudrate to 115200.
Download the FPGA bitstream into the FPGA using the FPGA vendor programming tool. 
After the FPGA was succesfully configured, you should see the welcome message on the terminal. 

.. figure:: ./images/uart-welcome.png
   :alt: uart-welcome.png
   :align: center
   Figure 5: Welcome

The application shows the target FPGA board. Also it shows the Tentiva base- and mezzanine boards information. 

The application configures the DPTX and DPRX IP-cores. It pings the DPTX IP-core to verify the DPTX IP-core is up and running. 
Same is done for the DPRX IP-core. Additionally for the DPRX the edid is written and the hot plug detect (HPD) is asserted. 

Colorbar
~~~~~~~~
After the menu options, you should see that the DPTX detected the hot plug (HPD) and it succesfully trained the link. 
Now press ``z`` for the colorbar mode. Then select one of the video resolutions. 
After selecting the video resolution the DPTX you should see the colorbar pattern on the DisplayPort sink device. 

.. figure:: ./images/uart-colorbar.png
   :alt: uart-colorbar.png
   :align: center
   Figure 6: Colorbar


Pass-through
~~~~~~~~~~~~
When the DisplayPort source video is enabled, you should see that the DPRX has succesfully trained and the link is up. 
Also it shows the detected incoming video parameters (in this example 1080p)
Now press ``x`` to enable the pass-through mode. 
You should see the video from the DisplayPort source device displayed on the DisplayPort sink device. 

.. figure:: ./images/uart-pass.png
   :alt: uart-pass.png
   :align: center
   Figure 6: Pass-through
